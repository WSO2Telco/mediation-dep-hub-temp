<?xml version="1.0" encoding="UTF-8"?>
<sequence name="apigeeUserInfoCallSeq" onError="apigeeUserInfoCallErrorSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">

  <class name="com.wso2telco.dep.spend.limit.mediation.mediator.apigeeTokenCacheLookup"/>

  <filter regex="false" source="boolean(get-property('apigeeAccessToken'))">
    <then>
      <sequence key="apigeeAuthCallSeq"/>
    </then>
    <else/>
  </filter>

  <header expression="fn:concat('Bearer ',get-property('apigeeAccessToken'))"
    name="Authorization" scope="transport"/>
    <property name="messageType" scope="axis2" type="STRING" value=""/>
  <!--<property name="Content-Type" scope="transport" type="STRING" value=""/>-->
  <call>
    <endpoint>
      <http method="get" trace="disable" uri-template="{uri.var.apigeeUserInfoEndpoint}"/>
    </endpoint>
  </call>
  <log level="custom">
    <property expression="get-property('axis2', 'HTTP_SC')" name="apigeeUserInfoCallSeq.HTTP_SC"/>
  </log>
  <switch source="get-property('axis2', 'HTTP_SC')">
    <case regex="200">
      <property
        expression="json-eval($.getSubscriberTypeResponse.userType)"
        name="userpackagetype" scope="default" type="STRING"/>
      <sequence key="pkgTypeSetSeq"/>
    </case>
    <case regex="401|403">
      <log level="custom">
        <property name="text" value="Forbidden or Unauthorized"/>
      </log>
      <sequence key="apigeeRefreshCallSeq"/>
        <sequence key="apigeeUserInfoCallErrorSeq"/>
    </case>
      <case regex="404">
          <log level="custom">
              <property name="text" value="404 NOT FOUND!"/>
          </log>
          <sequence key="apigeeUserInfoCallErrorSeq"/>
      </case>
    <default>
      <log level="custom">
        <property name="text" value="HITS DEFAULT HTTPSSC"/>
      </log>
      <sequence key="apigeeUserInfoCallErrorSeq"/>
    </default>
  </switch>
</sequence>
