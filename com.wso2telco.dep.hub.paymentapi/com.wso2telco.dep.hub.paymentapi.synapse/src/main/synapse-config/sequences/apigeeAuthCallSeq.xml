<?xml version="1.0" encoding="UTF-8"?>
<sequence xmlns="http://ws.apache.org/ns/synapse" name="apigeeAuthCallSeq" onError="apigeeUserInfoCallErrorSeq" trace="disable">
  <header expression="get-property('apigeeAuthToken')" name="Authorization" scope="transport" />
  <payloadFactory media-type="xml">
    <format>
      <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
        <soapenv:Header />
        <soapenv:Body>
          <root>
            <grant_type>password</grant_type>
            <username>$1</username>
            <password>$2</password>
            <scope />
          </root>
        </soapenv:Body>
      </soapenv:Envelope>
    </format>
    <args>
      <arg evaluator="xml" expression="get-property('apigeeUsername')" />
      <arg evaluator="xml" expression="get-property('apigeePassword')" />
    </args>
  </payloadFactory>
  <property name="messageType" scope="axis2" type="STRING" value="application/x-www-form-urlencoded" />
  <call>
    <endpoint>
      <http method="post" uri-template="{uri.var.apigeeTokenEndpoint}" />
    </endpoint>
  </call>
  <log level="custom">
    <property name="apigeeAuthCallSeq" expression="get-property('axis2', 'HTTP_SC')" />
  </log>

  <switch source="get-property('axis2', 'HTTP_SC')">
    <case regex="500">
      <log level="custom">
        <property name="apigeeAuthCallSeq.LOG" value="Invalid Auth token. "/>
      </log>
      <sequence key="apigeeUserInfoCallErrorSeq"/>
    </case>
    <default/>
  </switch>
  <!--change registry path to save in a collection named after the operator. Change all usages accordingly!-->
  <property name="apigeeAccessToken" scope="default" expression="json-eval($.access_token)" type="STRING" />
  <property name="apigeeRefreshToken" scope="default" expression="json-eval($.refresh_token)" type="STRING" />
  <class name="com.wso2telco.dep.spend.limit.mediation.mediator.apigeeTokenCache" />
</sequence>