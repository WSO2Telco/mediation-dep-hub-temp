<?xml version="1.0" encoding="UTF-8"?>
<sequence name="apigeeRefreshCallSeq" onError="apigeeUserInfoCallErrorSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
  <header expression="get-property('apigeeRefreshToken')"
    name="Authorization" scope="transport"/>
  <payloadFactory media-type="xml">
    <format>
      <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
        <soapenv:Header/>
        <soapenv:Body>
          <root>
            <grant_type>refresh_token</grant_type>
            <refresh_token>$1</refresh_token>
          </root>
        </soapenv:Body>
      </soapenv:Envelope>
    </format>
    <args>
      <arg evaluator="xml" expression="get-property('apigeeRefreshToken')"/>
    </args>
  </payloadFactory>
  <property name="messageType" scope="axis2" type="STRING" value="application/x-www-form-urlencoded"/>
  <call>
    <endpoint>
      <http method="post" uri-template="{uri.var.apigeeTokenEndpoint}" />
    </endpoint>
  </call>
  <log level="custom">
    <property expression="get-property('axis2', 'HTTP_SC')" name="apigeeRefreshCallSeq.HTTP_SC"/>
  </log>
  <switch source="get-property('axis2', 'HTTP_SC')">
    <case regex="500">
      <log level="custom">
        <property name="apigeeRefreshCallSeq.LOG" value="Invalid refresh token. "/>
      </log>
      <sequence key="apigeeAuthCallSeq"/>
      <sequence key="apigeeUserInfoCallErrorSeq"/>
    </case>
    <default/>
  </switch>
  <!--change registry path to save in a collection named after the operator. Change all usages accordingly!-->
  <property expression="json-eval($.access_token)"
    name="apigeeAccessToken" scope="default" type="STRING"/>
  <property expression="json-eval($.refresh_token)"
    name="apigeeRefreshToken" scope="default" type="STRING"/>
  <class name="com.wso2telco.dep.spend.limit.mediation.mediator.apigeeTokenCache" />
</sequence>
